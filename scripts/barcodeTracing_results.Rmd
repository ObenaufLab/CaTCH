---
title: "Clone survival screens"
author: "Kimon Froussios"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pdfstart}
#pdf('/Volumes/groups/obenauf/Kimon_Froussios/chris/YUMM17_barcode_tracing/paper/experiment2.pdf', paper="a4")
```

# Preparation

Libraries.

```{r libraries, result="hide", warning=FALSE}
library(data.table)
library(tidyverse)
library(readxl)
library(plotly)
library(ggrepel)
library(RColorBrewer)
```

Load data.

```{r data}
counts <- fread('/Volumes/groups/obenauf/Kimon_Froussios/chris/YUMM17_barcode_tracing/paper/experiment2.txt')
counts[is.na(counts)] <- 0

# Assign a numeric ID to barcodes by abundance in reference.
counts[, bc_id := frank(counts, -Reference, ties.method='first')]
setkey(counts, bc_id)

# counts columns with counts
cntCols <- 2:(length(counts)-1)
```

Thresholds

```{r thresholds}
count_thresh = 50
abund_thresh <- 0.01
```

Set sample order.

```{r order}
# Tidy up sample names.
sampleNames <- c("Reference", "UT_414", "UT_416", "UT_417", "UT_475", "D+T_411",  "D+T_412", "D+T_413", "D+T_415", "D+T_418")
#sampleNames <- names(counts[, -c(1,length(counts)), with=FALSE])
samples_tidy <- data.frame(name=factor(sampleNames, levels=sampleNames, ordered=TRUE), 
                           treatment=c('ref', rep('UT', 4), rep('DT', 5)))
# Exclude these when looking for enriched barcodes.
#controls = c("Reference_1", "Reference_2", "DMSO_1", "DMSO_2", "DMSO_3", "DMSO_4", "DMSO_5", "DMSO_6")
controls = c(NA_character_)
```

Plots' theme.

```{r theme}
# ggplot2 theme.
gth <- theme(axis.line.x= element_line(),
	         axis.line.y= element_line(),
	         strip.background= element_rect(fill= "grey95"),
	         strip.text.y= element_text(size= rel(1.2)),
	         strip.text.x= element_text(size= rel(1.1)),
	         panel.background= element_rect(fill = "white"),
	         panel.grid.major = element_line(colour="grey95"),
	         panel.grid.minor= element_blank(),
	         legend.key = element_rect(fill = 'white'),
	         plot.margin = unit(c(0.3, 1, 0.3, 0.3),"cm"),
	         axis.text.x = element_text(angle=90, hjust=1),
	         legend.position = "none"
)

getPalette <- colorRampPalette(brewer.pal(8, "Accent"))
# treatCols <- c(ref="forestgreen", DMSO="green3", ERL="dodgerblue", AFAT="orchid1", OSI="firebrick", bc="orange")
treatCols <- getPalette(length(sampleNames))
```

Calculate proportions and tidy up the data format.

```{r tidydata}
# Number of reads and number of detected barcodes in each sample.
libsizes <- sapply(counts[, cntCols, with=FALSE], sum)
numBarcodes <- sapply(counts[, cntCols, with=FALSE], function (x) { sum(x>0) } )
numGoodBarcodes <- sapply(counts[, cntCols, with=FALSE], function (x) { sum(x>count_thresh) } )

# Barcode abundances as fractions of the library sizes
relative <- as.data.table(lapply(names(counts[, -1, with=FALSE]), function(x) { 
                                  if (x=='bc_id') { 
                                    return(counts$bc_id)
                                  } else {          
                                    return(counts[[x]] / libsizes[x])
                                  }} ))
names(relative) <- names(counts[, -1, with=FALSE])
setkey(relative, bc_id)

# BArcodes passing the abundance threshold.
numBarcodesThresh <- sapply(relative[, 1:(length(relative)-1)], function (x) { sum(x >= abund_thresh) } )

# Make tidy summary of counts.
count_summary <- data.table(Count = as.double(c(libsizes, numBarcodes, numGoodBarcodes, numBarcodesThresh)),
                            Type = factor(c(rep('Reads', length(libsizes)), 
                                            rep('all_BCs', length(numBarcodes)),
                                            rep('fltr_BCs', length(numGoodBarcodes)),
                                            rep('top_Barcodes', length(numBarcodesThresh)) ),
                                          levels= c('all_BCs', 'fltr_BCs', 'top_Barcodes', 'Reads')),
                            Sample = c(names(libsizes), names(numBarcodes), names(numGoodBarcodes), names(numBarcodesThresh)) )
count_summary[, Sample := factor(count_summary$Sample, levels=sampleNames, ordered=TRUE)]
setorder(count_summary, Sample)

# Make the proportions tidy too.
relative_tidy <- as.data.table(relative %>% gather(key="Sample", value="Proportion", -bc_id))
relative_tidy[, Sample := factor(relative_tidy$Sample, levels=sampleNames, ordered=TRUE)]
setorder(relative_tidy, Sample)

# I'll need tidy counts too...
counts_tidy <- as.data.table(counts %>% 
                               select(-barcode) %>%
                               gather(key="Sample", value="Reads", -bc_id) )
counts_tidy[, Sample := factor(counts_tidy$Sample, levels=sampleNames, ordered=TRUE)]
setorder(counts_tidy, Sample)
all_tidy <- merge(counts_tidy, relative_tidy, by=c("bc_id", "Sample"))
all_tidy[, Sample := factor(all_tidy$Sample, levels=sampleNames, ordered=TRUE)]
setorder(all_tidy, Sample)

rm(relative_tidy)
rm(counts_tidy)
```

Create categories.

```{r categories}
# Make selection variable for the counts
counts_bool <- as.data.table(lapply(names(counts[, -1, with=FALSE]), function(x) { 
                                  if (x=='bc_id') { 
                                    return(counts$bc_id)
                                  } else {          
                                    return(counts[[x]] > count_thresh)
                                  }} ))
names(counts_bool) <- names(counts[, -1, with=FALSE])
setkey(counts_bool, bc_id)
counts_bool_tidy <- as.data.table(counts_bool %>% gather(key="Sample", value="count_Good", -bc_id))
counts_bool_tidy[, Sample := factor(counts_bool_tidy$Sample, levels=sampleNames, ordered=TRUE)]
all_tidy <- merge(all_tidy, counts_bool_tidy, by=c("bc_id", "Sample"))
setorder(all_tidy, Sample)

rm(counts_bool_tidy)
rm(counts_bool)

# Make selection variable for the proportions
all_tidy[, prop_Top := Proportion > abund_thresh]

# Make selection variables for treatment mouse and essay.
all_tidy <- merge(all_tidy, samples_tidy, by.x="Sample", by.y="name")
all_tidy[, Sample := factor(all_tidy$Sample, levels=sampleNames, ordered=TRUE)]
setorder(all_tidy, Sample)
rm(samples_tidy)
```

# Number of reads and barcodes

```{r counts}
# Basic faceted barplot
p <- ggplot(data=droplevels(count_summary[(Type != "top_Barcodes"), ]), aes(x=Sample, y=Count, fill=Type))  +
        facet_grid(Type ~ ., scales = "free") +
        geom_bar(stat='identity', width=0.7, size=0.2) +
        scale_fill_manual(values = c(all_BCs = "mediumorchid2", 
                                     fltr_BCs = "mediumorchid3", 
                                     Reads= "darkgoldenrod2")) +
        ggtitle("Total # of reads, and # of detected barcodes") +
          gth + theme(legend.position = "none")
print( p + scale_y_continuous(expand = expand_scale(mult = c(0, .15)), limits = c(0, NA)) )
# print( p + scale_y_sqrt(expand = expand_scale(mult = c(0, .15)), limits = c(0, NA)) )
```

# Distribution of barcode abundances above threshold

Mind that the Y-axis scale is **logarithmic**, meaning the distributions are much more top-skewed than they appear.

```{r proportions}
print(
  all_tidy %>% 
    filter(count_Good) %>%
    ggplot(aes(x=Sample, y=Proportion)) +
      geom_violin(aes(fill=treatment), width=1) +
      geom_boxplot(fill="white", width=0.1, outlier.size=1.3, outlier.alpha=0.33) +
      geom_hline(yintercept = abund_thresh, linetype='dotted') +
      scale_y_log10() +
      scale_fill_manual(values=treatCols) +
      ggtitle("Barcode abundances", subtitle=paste("for barcodes with at least", count_thresh, "reads")) +
  gth + theme(panel.grid.minor.y = element_line(colour='grey95'))
)
```

# Barcode Complexity

```{r complexity}
# Identify shared top barcodes
sharedBarcodes <- all_tidy %>%
  filter( ! Sample %in% controls) %>%
  filter(prop_Top) %>%
  group_by(bc_id) %>%
  summarise(numSamples=n()) %>%
  filter(numSamples > 1)

# Create selection variable for shared top-ness.
all_tidy[, is_Shared := bc_id %in% sharedBarcodes$bc_id]
```

Top barcodes that are shared among at least 2 samples.

```{r complexity2}
print( as.data.table(all_tidy %>% 
         filter(is_Shared, prop_Top) %>%
         group_by(bc_id) %>% 
         summarise(Samples = paste(Sample, collapse = " ; ")))
)
```

The colours identify shared barcodes across samples. Samples without barcodes meeting the threshold are not shown.

```{r complexity_plots}
# Prepare colour fill.
all_tidy[, sharedFill := ifelse(bc_id %in% sharedBarcodes$bc_id, bc_id, NA)]
# all_tidy[, sharedFill := factor(ifelse(bc_id %in% sharedBarcodes$bc_id, bc_id, NA), levels=c(-200, -2, 0, unique(ifelse(bc_id %in% sharedBarcodes$bc_id, bc_id, NA))))]

# Numbers of Barcodes
secScale <- max(numBarcodesThresh) / max(numBarcodes)
count_summary[, scaledCount := Count / secScale]

# Filter data, then add dummy entries for any samples that have no qualifying barcodes, so they are still shown on the axis.
tmp <- all_tidy %>% 
  filter(prop_Top) %>%
  arrange(desc(Proportion))
dropped <- unique(all_tidy$Sample)[! unique(all_tidy$Sample) %in% unique(tmp$Sample)]
if (length(dropped > 0)) {
  tmp <- rbind(tmp, data.frame(Sample=dropped, bc_id=-2, Reads=0, Proportion=0, count_Good=NA, prop_Top=FALSE, treatment=NA, is_Shared=NA, sharedFill=NA))
}
# Pad Samples to 100%
pad <- tmp %>%
  group_by(Sample) %>%
  summarise(Proportion = 1 - sum(Proportion))
tmp <- rbind(tmp, data.frame(Sample=pad$Sample, bc_id=-200, Reads=0, Proportion=pad$Proportion, count_Good=NA, prop_Top=FALSE, treatment=NA, is_Shared=NA, sharedFill=-200))

p <- ggplot(data=tmp, aes(x=Sample, y=Proportion, fill=sharedFill, group="A", label=bc_id)) +
         geom_bar(stat='identity', position=position_stack(), colour="black", width=0.9, size=0.2) +
         scale_y_continuous(expand = c(0, 0), limits= c(0,1),
                            sec.axis = sec_axis(trans = ~ .)) +
         # scale_fill_manual(values=c("black", getPalette(1 + nrow(sharedBarcodes))), na.value="grey90") +
         scale_fill_gradientn(colours=c("black", getPalette(1 + nrow(sharedBarcodes))), na.value="grey90") +
         ylab("Individual barcode proportion") +
         ggtitle(paste0("Barcodes with at least ", abund_thresh * 100,"% representation")) +
         gth + theme(panel.grid.major.x = element_blank(), legend.position="none")

# Static (for PDF)
# print(p)
```

```{r complexity_plots2}
# Interactive for HTML.
ggplotly(p)
rm(tmp)
```

Number of barcodes passing the counts threshold vs. number of barcodes passing the representation threshold.

```{r complexity_plots3}
# The labels can create terrible clutter if the plot is small with lots of points. 
# Plotly enables hover-over to get Sample info
ggplotly(
  ggplot(data=all_tidy %>%
                filter(count_Good) %>%
                group_by(Sample) %>%
                summarise(n_Barcodes=n(), n_TopBarcodes=sum(prop_Top), Treatment=unique(treatment)),
         aes(label=Sample, x=n_Barcodes, y=n_TopBarcodes, colour=Treatment)) +
    geom_point(shape=16, size=1, alpha=0.6) +
    scale_colour_manual(values=treatCols) +
    ggtitle("Barcode Diversity") +
    gth + theme(legend.position = "right")
)

# Static version with labels.
# print(
#   ggplot(data=all_tidy %>% 
#                 filter(count_Good) %>%
#                 group_by(Sample) %>% 
#                 summarise(n_Barcodes=n(), n_TopBarcodes=sum(prop_Top), Treatment=unique(treatment)), 
#          aes(label=Sample, x=n_Barcodes, y=n_TopBarcodes, fill=Treatment)) +
#     geom_label_repel(colour="black", fill="white", size=3, direction="both", force=1, min.segment.length = 0) +
#     geom_point(shape=21) +
#     scale_fill_manual(values=treatCols) +
#     ggtitle("Barcode Diversity") +
#     gth
# )
```

# Enrichment of top shared barcodes

## Distribution

Mind that the Y-axis scale is **logarithmic**. Outliers at the top are much farther away from the main bulk of the distribution than they appear.

```{r enrichment}
for (bc in sharedBarcodes$bc_id) {
  # Create dummy sample with the abundances of the given barcode only.
  # Preserve sample order.
  tmp <- all_tidy[(bc_id==bc),]
  bct <- paste("bc:", bc)
  tmp$Sample <- factor(bct, levels=c(sampleNames, bct), ordered=TRUE)
  tmp$treatment <- "bc"
  tmp2 <- all_tidy[(count_Good),]
  tmp2$Sample <- factor(tmp2$Sample, levels=c(sampleNames, bct), ordered=TRUE)
  tmp <- rbind(tmp2, tmp)
  
  print(paste('Barcode', bc))
  print(counts$barcode[counts$bc_id==bc])
  print(
    ggplot(data=tmp, aes(x=Sample, y=Proportion, fill=treatment)) +
      geom_hline(yintercept=abund_thresh, linetype='dotted') +
      geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
      geom_boxplot(colour="transparent", fill="transparent", outlier.colour="black", outlier.size = 1, outlier.alpha = 0.33) +
      geom_point(data=all_tidy[(bc_id == bc), ], fill="orange", size=2, shape=23) +
      scale_y_log10() +
      scale_fill_manual(values=treatCols) +
      ggtitle(paste("Abundance of barcode",bc)) +
      gth + theme(panel.grid.minor.y = element_line(colour='grey95'))
  )
}
```

## Matrix

```{r enrichment2, fig.height = 10, fig.width = 7}
top <- all_tidy %>% 
  filter(prop_Top) %>%
  select(bc_id) %>%
  arrange(bc_id) %>%
  unique()

p <- all_tidy %>%
  arrange(bc_id) %>%
  filter(bc_id %in% top$bc_id) %>%
  select(Sample, bc_id, Proportion) %>%
  mutate(bc_id=factor(as.character(bc_id), levels=as.character(top$bc_id))) %>%
  ggplot(aes(x=Sample, y=bc_id, fill=Proportion)) +
    geom_tile() +
    scale_fill_gradient(low="transparent", high="red4") +
    theme(axis.text.x=element_text(angle=90),
          panel.background = element_rect(fill="white"),
          panel.grid.major = element_line(colour="grey97"),
          legend.position = "right")
ggplotly(p)
#print(p)
```




```{r pdfend}
#dev.off()
```
